name: Collect Liquidity Data

on:
  # Automated cadence (no chaining required)
  schedule:
    - cron: '*/30 * * * *'

  # Manual trigger
  workflow_dispatch:

# Prevent overlapping runs
concurrency:
  group: liquidity-collector
  cancel-in-progress: false

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      # Set repo/environment var HTTP_PROXY_PREFIX (preferred),
      # or NEXT_PUBLIC_HTTP_PROXY_PREFIX for compatibility.
      HTTP_PROXY_PREFIX: ${{ secrets.HTTP_PROXY_PREFIX || vars.HTTP_PROXY_PREFIX || vars.NEXT_PUBLIC_HTTP_PROXY_PREFIX }}

    # Kill switch â€” set COLLECT_ENABLED to "false" in repo variables to stop
    if: vars.COLLECT_ENABLED != 'false'

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # For orgs that force read-only GITHUB_TOKEN, set DATA_PUSH_TOKEN (PAT) in repo secrets.
          token: ${{ secrets.DATA_PUSH_TOKEN || github.token }}
          # Full history avoids shallow-clone edge cases during pull --rebase.
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run collector (15 minutes)
        run: npx tsx src/main.ts --mode once

      - name: Upload error logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: collector-logs-${{ github.run_id }}
          path: data/logs/**
          if-no-files-found: ignore
          retention-days: 14

      - name: Commit and push data
        env:
          DATA_PUSH_TOKEN: ${{ secrets.DATA_PUSH_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/*.csv

          # Only commit if there are changes
          if git diff --cached --quiet; then
            echo "No new data to commit"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "data: update ${TIMESTAMP}"

            MAX_ATTEMPTS=3
            ATTEMPT=1

            while [ "$ATTEMPT" -le "$MAX_ATTEMPTS" ]; do
              echo "Sync/push attempt ${ATTEMPT}/${MAX_ATTEMPTS}"

              if git pull --rebase; then
                if [ -n "$DATA_PUSH_TOKEN" ]; then
                  if git push "https://x-access-token:${DATA_PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" "HEAD:${GITHUB_REF_NAME}"; then
                    echo "Push succeeded"
                    exit 0
                  fi
                else
                  if git push; then
                    echo "Push succeeded"
                    exit 0
                  fi
                fi
              else
                echo "Rebase conflict detected. Aborting rebase and retrying."
                git rebase --abort || true
              fi

              ATTEMPT=$((ATTEMPT + 1))
              sleep 5
            done

            echo "Could not push after ${MAX_ATTEMPTS} attempts. Skipping this run to keep workflow healthy."
            exit 0
          fi
